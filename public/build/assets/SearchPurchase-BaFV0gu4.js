import{r,a as M,j as t}from"./app-CQ-G37p-.js";import{B as Y}from"./button-ymMXdPy5.js";import{I as ae}from"./input-BXXA-PDa.js";import{C as O,d as W}from"./card-Bq41eL_q.js";import{h as X}from"./moment-C5S46NFB.js";import{L as G}from"./loader-circle-i2ANfqrZ.js";import{S as ne}from"./search-B9EA-nRY.js";import{X as J}from"./x-D2Pel9EU.js";import{R as Z}from"./receipt-Du83-98g.js";function xe({onChange:j,value:m,nextRef:f,purchaseNumberRef:d,clearable:q=!1,vendorId:R}){var U,V;const[n,h]=r.useState({id:"",number:"",purchase_date:"",total_amount:"0"}),[N,b]=r.useState(!1),[k,u]=r.useState(""),[i,x]=r.useState([]),[g,l]=r.useState(!1),[p,v]=r.useState(-1),[H,D]=r.useState(1),[T,_]=r.useState(!0),[C,B]=r.useState(!1),[w,$]=r.useState(""),E=r.useRef(null),I=r.useRef(null),y=r.useRef([]),L=r.useRef();r.useEffect(()=>{m&&h({id:m.id||"",number:m.number||"",purchase_date:m.purchase_date||"",total_amount:m.total_amount||"0",vendor:m.vendor,division:m.division})},[]),r.useEffect(()=>{v(-1),y.current=[]},[i]);const z=r.useCallback(e=>{if(y.current[e]&&E.current){const s=y.current[e],a=E.current;if(s){const o=s.offsetTop,c=o+s.offsetHeight,S=a.scrollTop,re=S+a.clientHeight;o<S?a.scrollTop=o-8:c>re&&(a.scrollTop=c-a.clientHeight+8)}}},[]),P=r.useCallback(e=>{var s,a;if(!g||i.length===0){e.key==="Enter"&&((s=f==null?void 0:f.current)==null||s.focus());return}switch(e.key){case"ArrowDown":e.preventDefault(),v(o=>{const c=o<i.length-1?o+1:0;return setTimeout(()=>z(c),0),c});break;case"ArrowUp":e.preventDefault(),v(o=>{const c=o>0?o-1:i.length-1;return setTimeout(()=>z(c),0),c});break;case"Enter":e.preventDefault(),p>=0&&p<i.length?(Q(i[p]),(a=f==null?void 0:f.current)==null||a.focus()):e.currentTarget===document.activeElement&&K(n.number??"");break;case"Escape":e.preventDefault(),l(!1),v(-1);break}},[g,i,p,n.number]),ee=e=>{const s=e.target.value;h(a=>({...a,number:s})),L.current&&clearTimeout(L.current),L.current=setTimeout(()=>{te(s)},300),u("")},te=r.useCallback(e=>{if(e.length<2){x([]),l(!1),$(""),D(1),_(!0);return}$(e),D(1),_(!0),A(e,1,!0)},[]),A=async(e,s,a=!1)=>{a?b(!0):B(!0);try{const o=await M.get("/admin/purchase/list",{params:{search:e,page:s,limit:10,vendor_id:R}}),c=o.data.data||[];x(a?c:S=>[...S,...c]),_(o.data.next_page_url!==null),l(c.length>0||i.length>0)}catch(o){console.error("Error fetching purchases:",o),u("Failed to fetch purchases")}finally{b(!1),B(!1)}},F=r.useCallback(()=>{if(!C&&T&&w){const e=H+1;D(e),A(w,e,!1)}},[C,T,w,H]),se=r.useCallback(e=>{const s=e.currentTarget,{scrollTop:a,scrollHeight:o,clientHeight:c}=s;o-a-c<50&&F()},[F]),K=async e=>{if(e.trim()){b(!0),u("");try{const{data:s}=await M.get(`/admin/purchase/list?search=${e}`);if(s.data&&s.data.length>0){const a=s.data[0];h(a),j(a),l(!1)}else u("Purchase not found")}catch(s){u("Failed to search purchase"),console.error(s)}finally{b(!1)}}},Q=async e=>{try{const{data:s}=await M.get(`/admin/purchase/${e.id}`);h(s.data),j(s.data),l(!1),x([])}catch(s){console.error("Error selecting purchase:",s)}};return r.useEffect(()=>{const e=s=>{I.current&&!I.current.contains(s.target)&&l(!1)};if(g)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[g]),r.useEffect(()=>{if(!n.id){const e=setTimeout(()=>{d!=null&&d.current&&d.current.focus()},50);return()=>clearTimeout(e)}},[n.id,d]),t.jsxs("div",{className:"space-y-3",ref:I,children:[n.id?null:t.jsxs("div",{className:"relative",children:[t.jsxs("div",{className:"flex gap-0 border rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-ring",children:[t.jsx(ae,{className:"border-0 rounded-none focus-visible:ring-0 focus-visible:ring-offset-0",placeholder:"Nomor Purchase",ref:d,onChange:ee,onKeyDown:P}),t.jsx(Y,{variant:"ghost",size:"sm",className:"rounded-none border-l px-3",onClick:()=>K(n.number??""),disabled:N,children:N?t.jsx(G,{className:"h-4 w-4 animate-spin"}):t.jsx(ne,{className:"h-4 w-4"})}),q&&(n.id||n.number)&&t.jsx(Y,{variant:"ghost",size:"sm",className:"rounded-none border-l px-3",onClick:()=>{var e;h({id:void 0}),x([]),l(!1),u(""),j({id:""}),(e=d==null?void 0:d.current)==null||e.focus()},children:t.jsx(J,{className:"h-4 w-4"})})]}),g&&t.jsx(O,{className:"absolute top-full left-0 right-0 z-[9999] mt-1 shadow-xl border-2",children:t.jsx(W,{className:"p-0",children:t.jsx("div",{ref:E,className:"max-h-64 overflow-y-auto overscroll-contain",onScroll:se,style:{scrollbarWidth:"thin",scrollbarColor:"#cbd5e1 #f1f5f9"},children:t.jsxs("div",{className:"p-2",children:[t.jsxs("div",{className:"text-xs text-muted-foreground mb-2 px-2 sticky top-0 bg-white dark:bg-black",children:["Search Results (",w,") - ",i.length," purchases"]}),i.map((e,s)=>{var a,o;return t.jsxs("div",{ref:c=>y.current[s]=c,className:`flex items-center justify-between p-3 rounded-md cursor-pointer transition-colors ${p===s?"bg-primary/10 border border-primary/20":"hover:bg-accent"}`,onClick:()=>Q(e),onMouseEnter:()=>v(s),children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 bg-primary/10 rounded-md",children:t.jsx(Z,{className:"h-4 w-4 text-primary"})}),t.jsxs("div",{children:[t.jsx("div",{className:"font-medium text-sm",children:e.number}),t.jsx("div",{className:"text-xs text-muted-foreground",children:((a=e==null?void 0:e.vendor)==null?void 0:a.name)||"No Vendor"}),t.jsx("div",{className:"text-xs text-muted-foreground",children:e.purchase_date?X(e.purchase_date).format("DD/MM/YYYY"):""})]})]}),t.jsxs("div",{className:"text-right",children:[t.jsxs("div",{className:"text-sm font-medium",children:["Rp ",Number.parseInt((e==null?void 0:e.total_amount)??"0").toLocaleString("id-ID")]}),t.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:((o=e==null?void 0:e.division)==null?void 0:o.name)||"No Division"})]})]},`${e.id}-${s}`)}),C&&t.jsxs("div",{className:"flex items-center justify-center p-4 bg-gray-50 dark:bg-gray-950",children:[t.jsx(G,{className:"h-4 w-4 animate-spin mr-2"}),t.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading more purchases..."})]}),!T&&i.length>0&&t.jsxs("div",{className:"text-center p-4 text-xs text-muted-foreground bg-gray-50 dark:bg-gray-950 border-t",children:["âœ… All purchases loaded (",i.length," total)"]}),i.length===0&&!N&&t.jsx("div",{className:"text-center p-4 text-sm text-muted-foreground",children:"No purchases found"})]})})})}),k&&t.jsx("div",{className:"text-sm text-destructive mt-2 p-2 bg-destructive/10 rounded-md",children:k})]}),n.id&&!N&&!k&&t.jsx(O,{className:"mt-3",children:t.jsx(W,{className:"p-4",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 bg-primary/10 rounded-md",children:t.jsx(Z,{className:"h-5 w-5 text-primary"})}),t.jsxs("div",{children:[t.jsx("div",{className:"font-medium text-sm",children:n.number}),t.jsx("div",{className:"text-sm text-muted-foreground",children:((U=n.vendor)==null?void 0:U.name)||"No Vendor"}),t.jsx("div",{className:"text-xs text-muted-foreground",children:n.purchase_date?X(n.purchase_date).format("DD/MM/YYYY"):""})]})]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"text-right",children:[t.jsxs("div",{className:"text-sm font-medium",children:["Rp ",Number.parseInt((n==null?void 0:n.total_amount)??"0").toLocaleString("id-ID")]}),t.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:((V=n==null?void 0:n.division)==null?void 0:V.name)||"No Division"})]}),t.jsxs(Y,{variant:"outline",size:"sm",onClick:()=>{h({id:"",number:"",purchase_date:"",total_amount:"0"}),x([]),l(!1),u(""),j({id:""})},className:"ml-2",children:[t.jsx(J,{className:"h-4 w-4 mr-1"}),"Ubah"]})]})]})})})]})}export{xe as S};
