import{r as s,a as F,j as r}from"./app-CQ-G37p-.js";import{I as Y}from"./input-BXXA-PDa.js";import{C as K,d as Q}from"./card-Bq41eL_q.js";import{P as z}from"./package-Cd0mGsRo.js";import{L as Z}from"./loader-circle-i2ANfqrZ.js";function ae({onChange:w,value:l,nextRef:d,itemCodeRef:O,itemNameRef:q,source:D}){const[o,x]=s.useState({id:"",item_name:"",price:"0",unit:"",description:""}),[I,N]=s.useState(!1),[S,f]=s.useState(""),[n,b]=s.useState([]),[p,m]=s.useState(!1),[u,h]=s.useState(-1),[H,k]=s.useState(1),[_,T]=s.useState(!0),[E,M]=s.useState(!1),[j,$]=s.useState(""),C=s.useRef(null),L=s.useRef(null),v=s.useRef([]),g=s.useRef();s.useEffect(()=>{l&&x({id:l.id||"",item_name:l.item_name||"",price:l.price||"0",unit:l.unit||"",description:l.description||""})},[]),s.useEffect(()=>{h(-1),v.current=[]},[n]);const P=s.useCallback(e=>{if(v.current[e]&&C.current){const t=v.current[e],i=C.current;if(t){const a=t.offsetTop,c=a+t.offsetHeight,y=i.scrollTop,X=y+i.clientHeight;a<y?i.scrollTop=a-8:c>X&&(i.scrollTop=c-i.clientHeight+8)}}},[]),U=s.useCallback(e=>{var t,i;if(!p||n.length===0){e.key==="Enter"&&((t=d==null?void 0:d.current)==null||t.focus());return}switch(e.key){case"ArrowDown":e.preventDefault(),h(a=>{const c=a<n.length-1?a+1:0;return setTimeout(()=>P(c),0),c});break;case"ArrowUp":e.preventDefault(),h(a=>{const c=a>0?a-1:n.length-1;return setTimeout(()=>P(c),0),c});break;case"Enter":e.preventDefault(),u>=0&&u<n.length?(B(n[u]),console.log("Selected item:",n[u]),(i=d==null?void 0:d.current)==null||i.focus()):e.currentTarget===document.activeElement&&(e.currentTarget,V(o.item_name??""));break;case"Escape":e.preventDefault(),m(!1),h(-1);break}},[p,n,u,o.item_name]),W=e=>{const t=e.target.value;x(i=>({...i,item_name:t})),w({...o,item_name:t,id:"",price:"0",unit:"",description:""}),g.current&&clearTimeout(g.current),g.current=setTimeout(()=>{G(t)},300),f("")},G=s.useCallback(e=>{if(e.length<2){b([]),m(!1),$(""),k(1),T(!0);return}$(e),k(1),T(!0),R(e,1,!0)},[]),R=async(e,t,i=!1)=>{i?N(!0):M(!0);try{const a=await F.get("/admin/item-non-stock/browse",{params:{search:e,page:t,limit:10,source:D||"purchase"}}),c=a.data.data||[];b(i?c:y=>[...y,...c]),T(a.data.next_page_url!==null),m(c.length>0||n.length>0)}catch(a){console.error("Error fetching items:",a),f("Failed to fetch items")}finally{N(!1),M(!1)}},A=s.useCallback(()=>{if(!E&&_&&j){const e=H+1;k(e),R(j,e,!1)}},[E,_,j,H]),J=s.useCallback(e=>{const t=e.currentTarget,{scrollTop:i,scrollHeight:a,clientHeight:c}=t;a-i-c<50&&A()},[A]),V=async e=>{if(e.trim()){N(!0),f("");try{const{data:t}=await F.get(`/admin/item-non-stock/search-by-code?search=${e}&source=${D}`);t.data?(x({id:t.data.id,item_name:t.data.item_name,price:t.data.price,unit:t.data.unit,description:t.data.description}),w({id:t.data.id,price:t.data.price,item_name:t.data.item_name,unit:t.data.unit,description:t.data.description}),m(!1)):f("Item not found")}catch(t){f("Failed to search item"),console.error(t)}finally{N(!1)}}},B=async e=>{try{x({id:e.id,item_name:e.item_name,price:e.price,unit:e.unit,description:e.description}),w({id:e.id,item_name:e.item_name,price:e.price,unit:e.unit,description:e.description}),m(!1),b([])}catch(t){console.error("Error selecting item:",t)}};return s.useEffect(()=>{const e=t=>{L.current&&!L.current.contains(t.target)&&m(!1)};if(p)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[p]),s.useEffect(()=>()=>{g.current&&clearTimeout(g.current)},[]),r.jsx("div",{className:"space-y-3",ref:L,children:r.jsxs("div",{className:"relative",children:[r.jsx("div",{className:"flex gap-0 border rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-ring",children:r.jsx("div",{className:"flex-1",children:r.jsx(Y,{className:"border-0 rounded-none focus-visible:ring-0 focus-visible:ring-offset-0",placeholder:"Item",ref:O,value:o.item_name,onChange:W,onKeyDown:U})})}),p&&r.jsx(K,{className:"absolute top-full left-0 right-0 z-[9999] mt-1 shadow-xl border-2",children:r.jsx(Q,{className:"p-0",children:r.jsx("div",{ref:C,className:"max-h-64 overflow-y-auto overscroll-contain",onScroll:J,style:{scrollbarWidth:"thin",scrollbarColor:"#cbd5e1 #f1f5f9"},children:r.jsxs("div",{className:"p-2",children:[r.jsxs("div",{className:"text-xs text-muted-foreground mb-2 px-2 sticky top-0 bg-white dark:bg-black",children:["Search Results (",j,") - ",n.length," items"]}),n.map((e,t)=>r.jsxs("div",{ref:i=>v.current[t]=i,className:`flex items-center justify-between p-3 rounded-md cursor-pointer transition-colors ${u===t?"bg-primary/10 border border-primary/20":"hover:bg-accent"}`,onClick:()=>B(e),onMouseEnter:()=>h(t),children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"p-2 bg-primary/10 rounded-md",children:r.jsx(z,{className:"h-4 w-4 text-primary"})}),r.jsx("div",{children:r.jsx("div",{className:"font-medium text-sm",children:e.item_name})})]}),r.jsx("div",{className:"text-right",children:r.jsxs("div",{className:"text-sm font-medium",children:["Rp ",Number.parseInt(e.price).toLocaleString("id-ID")]})})]},`${e.id}-${t}`)),E&&r.jsxs("div",{className:"flex items-center justify-center p-4 bg-gray-50 dark:bg-gray-950",children:[r.jsx(Z,{className:"h-4 w-4 animate-spin mr-2"}),r.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading more items..."})]}),!_&&n.length>0&&r.jsxs("div",{className:"text-center p-4 text-xs text-muted-foreground bg-gray-50 dark:bg-gray-950 border-t",children:["âœ… All items loaded (",n.length," total)"]}),n.length===0&&!I&&r.jsx("div",{className:"text-center p-4 text-sm text-muted-foreground",children:"No items found"})]})})})}),S&&r.jsx("div",{className:"text-sm text-destructive mt-2 p-2 bg-destructive/10 rounded-md",children:S}),o.id&&!I&&!S&&r.jsx(K,{className:"mt-3",children:r.jsx(Q,{className:"p-4",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"p-2 bg-primary/10 rounded-md",children:r.jsx(z,{className:"h-5 w-5 text-primary"})}),r.jsxs("div",{children:[r.jsx("div",{className:"font-medium",children:o.item_name}),o.description&&r.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:o.description})]})]}),r.jsx("div",{className:"text-right",children:r.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:["Rp ",Number.parseInt(o.price).toLocaleString("id-ID")]})})]})})})]})})}export{ae as S};
