import{r,a as j,j as s}from"./app-CQ-G37p-.js";import{B as G}from"./button-ymMXdPy5.js";import{I as J}from"./input-BXXA-PDa.js";import{C as R,d as V}from"./card-Bq41eL_q.js";import{B as ie}from"./badge-CsIJHFj0.js";import{L as Y}from"./loader-circle-i2ANfqrZ.js";import{S as oe}from"./search-B9EA-nRY.js";import{X as de}from"./x-D2Pel9EU.js";import{P as Z}from"./package-Cd0mGsRo.js";function be({onChange:v,value:l,warehouseId:I=null,nextRef:h,itemCodeRef:_,itemNameRef:q,clearable:ee=!1}){const[a,p]=r.useState({id:"",code:"",name:"",purchase_price:"0",selling_price:"0",unit:"",description:""}),[y,f]=r.useState(!1),[T,d]=r.useState(""),[i,x]=r.useState([]),[te,E]=r.useState(""),[N,m]=r.useState(!1),[g,b]=r.useState(-1),[M,C]=r.useState(1),[D,L]=r.useState(!0),[B,K]=r.useState(!1),[w,P]=r.useState(""),$=r.useRef(null),H=r.useRef(null),k=r.useRef([]),u=r.useRef();r.useEffect(()=>{l&&p({id:l.id||"",code:l.code||"",name:l.name||"",purchase_price:l.purchase_price||"0",selling_price:l.selling_price||"0",unit:l.unit||"",description:l.description||""})},[]),r.useEffect(()=>{b(-1),k.current=[]},[i]);const z=r.useCallback(t=>{if(k.current[t]&&$.current){const e=k.current[t],c=$.current;if(e){const n=e.offsetTop,o=n+e.offsetHeight,S=c.scrollTop,ne=S+c.clientHeight;n<S?c.scrollTop=n-8:o>ne&&(c.scrollTop=o-c.clientHeight+8)}}},[]),A=r.useCallback(t=>{var e,c;if(!N||i.length===0){t.key==="Enter"&&((e=h==null?void 0:h.current)==null||e.focus());return}switch(t.key){case"ArrowDown":t.preventDefault(),b(n=>{const o=n<i.length-1?n+1:0;return setTimeout(()=>z(o),0),o});break;case"ArrowUp":t.preventDefault(),b(n=>{const o=n>0?n-1:i.length-1;return setTimeout(()=>z(o),0),o});break;case"Enter":t.preventDefault(),g>=0&&g<i.length?(X(i[g]),console.log("Selected item:",i[g]),(c=h==null?void 0:h.current)==null||c.focus()):t.currentTarget===document.activeElement&&(t.currentTarget.placeholder==="Kode Item"?U(a.code??""):W(a.name??""));break;case"Escape":t.preventDefault(),m(!1),b(-1);break}},[N,i,g,a.code,a.name]);r.useEffect(()=>{async function t(){if(a.id)try{const{data:e}=await j.get(`/admin/item/stock/${a.id}`,{params:{warehouse_id:I}});E(e.data.stock)}catch(e){console.error("Error fetching stock:",e)}}t()},[a.id,I]);const se=t=>{const e=t.target.value;p(c=>({...c,code:e})),u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{F(e)},300),d("")},re=t=>{const e=t.target.value;p(c=>({...c,name:e})),u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{F(e)},300),d("")},F=r.useCallback(t=>{if(t.length<2){x([]),m(!1),P(""),C(1),L(!0);return}P(t),C(1),L(!0),Q(t,1,!0)},[]),Q=async(t,e,c=!1)=>{c?f(!0):K(!0);try{const n=await j.get("/admin/item/browse",{params:{search:t,page:e,limit:10}}),o=n.data.data||[];x(c?o:S=>[...S,...o]),L(n.data.next_page_url!==null),m(o.length>0||i.length>0)}catch(n){console.error("Error fetching items:",n),d("Failed to fetch items")}finally{f(!1),K(!1)}},O=r.useCallback(()=>{if(!B&&D&&w){const t=M+1;C(t),Q(w,t,!1)}},[B,D,w,M]),ae=r.useCallback(t=>{const e=t.currentTarget,{scrollTop:c,scrollHeight:n,clientHeight:o}=e;n-c-o<50&&O()},[O]),U=async t=>{if(t.trim()){f(!0),d("");try{const{data:e}=await j.get(`/admin/item/search-by-code?search=${t}`);e.data?(p({id:e.data.id,code:e.data.code,name:e.data.name,purchase_price:e.data.purchase_price,selling_price:e.data.selling_price,unit:e.data.unit,description:e.data.description}),v({id:e.data.id,code:e.data.code,name:e.data.name,purchase_price:e.data.purchase_price,selling_price:e.data.selling_price,unit:e.data.unit,description:e.data.description}),m(!1)):d("Item not found")}catch(e){d("Failed to search item"),console.error(e)}finally{f(!1)}}},W=async t=>{if(t.trim()){f(!0),d("");try{const{data:e}=await j.get(`/admin/item/search-by-name?search=${t}`);e.data?(p({id:e.data.id,code:e.data.code,name:e.data.name,purchase_price:e.data.purchase_price,selling_price:e.data.selling_price,unit:e.data.unit,description:e.data.description}),v({id:e.data.id,code:e.data.code,name:e.data.name,purchase_price:e.data.purchase_price,selling_price:e.data.selling_price,unit:e.data.unit,description:e.data.description}),m(!1)):d("Item not found")}catch(e){d("Failed to search item"),console.error(e)}finally{f(!1)}}},ce=()=>{a.code?U(a.code):a.name&&W(a.name)},X=async t=>{try{const{data:e}=await j.get(`/admin/item/stock/${t.id}`,{params:{warehouse_id:I}});p({id:e.data.id,code:e.data.code,name:e.data.name,purchase_price:e.data.purchase_price,selling_price:e.data.selling_price,unit:e.data.unit,description:e.data.description}),v({id:e.data.id,code:e.data.code,name:e.data.name,purchase_price:e.data.purchase_price,selling_price:e.data.selling_price,unit:e.data.unit,description:e.data.description}),E(e.data.stock),m(!1),x([])}catch(e){console.error("Error selecting item:",e)}};return r.useEffect(()=>{const t=e=>{H.current&&!H.current.contains(e.target)&&m(!1)};if(N)return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[N]),r.useEffect(()=>()=>{u.current&&clearTimeout(u.current)},[]),s.jsx("div",{className:"space-y-3",ref:H,children:s.jsxs("div",{className:"relative",children:[s.jsxs("div",{className:"flex gap-0 border rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-ring",children:[s.jsx("div",{className:"flex-1",children:s.jsx(J,{className:"border-0 rounded-none focus-visible:ring-0 focus-visible:ring-offset-0",placeholder:"Kode Item",ref:_,value:a.code,onChange:se,onKeyDown:A})}),s.jsx(G,{variant:"ghost",size:"sm",className:"rounded-none border-l border-r px-3",onClick:ce,disabled:y,children:y?s.jsx(Y,{className:"h-4 w-4 animate-spin"}):s.jsx(oe,{className:"h-4 w-4"})}),s.jsx("div",{className:"flex-[2]",children:s.jsx(J,{ref:q,className:"border-0 rounded-none focus-visible:ring-0 focus-visible:ring-offset-0",placeholder:"Nama Item",value:a.name,onChange:re,onKeyDown:A})}),ee&&(a.id||a.code||a.name)&&s.jsx(G,{variant:"ghost",size:"sm",className:"rounded-none border-l px-3",onClick:()=>{var t;p({id:"",code:"",name:"",purchase_price:"0",selling_price:"0",unit:"",description:""}),E(""),x([]),m(!1),d(""),v({id:"",code:"",name:"",purchase_price:"0",selling_price:"0",unit:"",description:""}),(t=_==null?void 0:_.current)==null||t.focus()},children:s.jsx(de,{className:"h-4 w-4"})})]}),N&&s.jsx(R,{className:"absolute top-full left-0 right-0 z-[9999] mt-1 shadow-xl border-2",children:s.jsx(V,{className:"p-0",children:s.jsx("div",{ref:$,className:"max-h-64 overflow-y-auto overscroll-contain",onScroll:ae,style:{scrollbarWidth:"thin",scrollbarColor:"#cbd5e1 #f1f5f9"},children:s.jsxs("div",{className:"p-2",children:[s.jsxs("div",{className:"text-xs text-muted-foreground mb-2 px-2 sticky top-0 bg-white dark:bg-black",children:["Search Results (",w,") - ",i.length," items"]}),i.map((t,e)=>s.jsxs("div",{ref:c=>k.current[e]=c,className:`flex items-center justify-between p-3 rounded-md cursor-pointer transition-colors ${g===e?"bg-primary/10 border border-primary/20":"hover:bg-accent"}`,onClick:()=>X(t),onMouseEnter:()=>b(e),children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"p-2 bg-primary/10 rounded-md",children:s.jsx(Z,{className:"h-4 w-4 text-primary"})}),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium text-sm",children:t.name}),s.jsx("div",{className:"text-xs text-muted-foreground",children:t.code})]})]}),s.jsxs("div",{className:"text-right",children:[s.jsxs("div",{className:"text-sm font-medium",children:["Rp ",Number.parseInt(t.purchase_price).toLocaleString("id-ID")]}),s.jsxs("div",{className:"text-sm font-medium",children:["Rp ",Number.parseInt(t.selling_price).toLocaleString("id-ID")]})]})]},`${t.id}-${e}`)),B&&s.jsxs("div",{className:"flex items-center justify-center p-4 bg-gray-50 dark:bg-gray-950",children:[s.jsx(Y,{className:"h-4 w-4 animate-spin mr-2"}),s.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading more items..."})]}),!D&&i.length>0&&s.jsxs("div",{className:"text-center p-4 text-xs text-muted-foreground bg-gray-50 dark:bg-gray-950 border-t",children:["âœ… All items loaded (",i.length," total)"]}),i.length===0&&!y&&s.jsx("div",{className:"text-center p-4 text-sm text-muted-foreground",children:"No items found"})]})})})}),T&&s.jsx("div",{className:"text-sm text-destructive mt-2 p-2 bg-destructive/10 rounded-md",children:T}),a.id&&!y&&!T&&s.jsx(R,{className:"mt-3",children:s.jsx(V,{className:"p-4",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"p-2 bg-primary/10 rounded-md",children:s.jsx(Z,{className:"h-5 w-5 text-primary"})}),s.jsxs("div",{children:[s.jsx("div",{className:"font-medium",children:a.name}),s.jsx("div",{className:"text-sm text-muted-foreground",children:a.code}),a.description&&s.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:a.description})]})]}),s.jsxs("div",{className:"text-right",children:[s.jsxs(ie,{variant:"secondary",className:"bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 hover:bg-green-100 dark:hover:bg-green-900",children:["Stock: ",te||"0"]}),s.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:["Rp ",Number.parseInt(a.purchase_price).toLocaleString("id-ID")]}),s.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:["Rp ",Number.parseInt(a.selling_price).toLocaleString("id-ID")]})]})]})})})]})})}export{be as S};
