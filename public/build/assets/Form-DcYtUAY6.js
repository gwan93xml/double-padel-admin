import{r as a,a as k,j as e,W as ie,y as X}from"./app-CQ-G37p-.js";import{B as I}from"./button-ymMXdPy5.js";import{I as ee}from"./input-BXXA-PDa.js";import{C as q,d as J}from"./card-Bq41eL_q.js";import{B as $}from"./badge-CsIJHFj0.js";import{L as Y}from"./loader-circle-i2ANfqrZ.js";import{S as ce}from"./search-B9EA-nRY.js";import{X as B}from"./x-D2Pel9EU.js";import{U as Z}from"./user-K2wipGb8.js";import{P as oe}from"./plus-gEoqNGty.js";import{F as R}from"./form-group-CHZXn8bM.js";import{t as M}from"./use-toast-XJEkqv7A.js";import"./index-D0iIn24t.js";import"./createLucideIcon-iWXofaGH.js";import"./label-Blk7FhF1.js";import"./index-DqZ46QiR.js";function le({onChange:m,value:v,nextRef:h,userEmailRef:i,clearable:f=!1}){var O;const[c,x]=a.useState({id:"",email:"",name:""}),[N,w]=a.useState(!1),[b,p]=a.useState(""),[l,j]=a.useState([]),[y,t]=a.useState(!1),[n,g]=a.useState(-1),[z,E]=a.useState(1),[_,D]=a.useState(!0),[P,F]=a.useState(!1),[S,H]=a.useState(""),U=a.useRef(null),A=a.useRef(null),C=a.useRef([]),L=a.useRef();a.useEffect(()=>{v&&x({id:v.id||"",email:v.email||"",name:v.name||""})},[]),a.useEffect(()=>{g(-1),C.current=[]},[l]);const V=a.useCallback(s=>{if(C.current[s]&&U.current){const r=C.current[s],o=U.current;if(r){const d=r.offsetTop,u=d+r.offsetHeight,T=o.scrollTop,ne=T+o.clientHeight;d<T?o.scrollTop=d-8:u>ne&&(o.scrollTop=u-o.clientHeight+8)}}},[]),se=a.useCallback(s=>{var r,o;if(!y||l.length===0){s.key==="Enter"&&((r=h==null?void 0:h.current)==null||r.focus());return}switch(s.key){case"ArrowDown":s.preventDefault(),g(d=>{const u=d<l.length-1?d+1:0;return setTimeout(()=>V(u),0),u});break;case"ArrowUp":s.preventDefault(),g(d=>{const u=d>0?d-1:l.length-1;return setTimeout(()=>V(u),0),u});break;case"Enter":s.preventDefault(),n>=0&&n<l.length?(W(l[n]),(o=h==null?void 0:h.current)==null||o.focus()):s.currentTarget===document.activeElement&&Q(c.email??"");break;case"Escape":s.preventDefault(),t(!1),g(-1);break}},[y,l,n,c.email]),te=s=>{const r=s.target.value;x(o=>({...o,email:r})),L.current&&clearTimeout(L.current),L.current=setTimeout(()=>{re(r)},300),p("")},re=a.useCallback(s=>{if(s.length<2){j([]),t(!1),H(""),E(1),D(!0);return}H(s),E(1),D(!0),K(s,1,!0)},[]),K=async(s,r,o=!1)=>{o?w(!0):F(!0);try{const d=await k.get("/admin/user/list",{params:{search:s,page:r,limit:10}}),u=d.data.data||[];j(o?u:T=>[...T,...u]),D(d.data.next_page_url!==null),t(u.length>0||l.length>0)}catch(d){console.error("Error fetching users:",d),p("Failed to fetch users")}finally{w(!1),F(!1)}},G=a.useCallback(()=>{if(!P&&_&&S){const s=z+1;E(s),K(S,s,!1)}},[P,_,S,z]),ae=a.useCallback(s=>{const r=s.currentTarget,{scrollTop:o,scrollHeight:d,clientHeight:u}=r;d-o-u<50&&G()},[G]),Q=async s=>{if(s.trim()){w(!0),p("");try{const{data:r}=await k.get(`/admin/user/list?search=${s}`);if(r.data&&r.data.length>0){const o=r.data[0];x(o),m(o),t(!1)}else p("User not found")}catch(r){p("Failed to search user"),console.error(r)}finally{w(!1)}}},W=async s=>{try{const{data:r}=await k.get(`/admin/user/${s.id}`);x(r.data),m(r.data),t(!1),j([])}catch(r){console.error("Error selecting user:",r)}};return a.useEffect(()=>{const s=r=>{A.current&&!A.current.contains(r.target)&&t(!1)};if(y)return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[y]),a.useEffect(()=>{if(!c.id){const s=setTimeout(()=>{i!=null&&i.current&&i.current.focus()},50);return()=>clearTimeout(s)}},[c.id,i]),e.jsxs("div",{className:"space-y-3",ref:A,children:[c.id?null:e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex gap-0 border rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-ring",children:[e.jsx(ee,{className:"border-0 rounded-none focus-visible:ring-0 focus-visible:ring-offset-0",placeholder:"Email User",ref:i,onChange:te,onKeyDown:se}),e.jsx(I,{variant:"ghost",size:"sm",className:"rounded-none border-l px-3",onClick:()=>Q(c.email??""),disabled:N,children:N?e.jsx(Y,{className:"h-4 w-4 animate-spin"}):e.jsx(ce,{className:"h-4 w-4"})}),f&&(c.id||c.email)&&e.jsx(I,{variant:"ghost",size:"sm",className:"rounded-none border-l px-3",onClick:()=>{var s;x({id:void 0}),j([]),t(!1),p(""),m({id:""}),(s=i==null?void 0:i.current)==null||s.focus()},children:e.jsx(B,{className:"h-4 w-4"})})]}),y&&e.jsx(q,{className:"absolute top-full left-0 right-0 z-[9999] mt-1 shadow-xl border-2",children:e.jsx(J,{className:"p-0",children:e.jsx("div",{ref:U,className:"max-h-64 overflow-y-auto overscroll-contain",onScroll:ae,style:{scrollbarWidth:"thin",scrollbarColor:"#cbd5e1 #f1f5f9"},children:e.jsxs("div",{className:"p-2",children:[e.jsxs("div",{className:"text-xs text-muted-foreground mb-2 px-2 sticky top-0 bg-white dark:bg-black",children:["Search Results (",S,") - ",l.length," users"]}),l.map((s,r)=>e.jsx("div",{ref:o=>C.current[r]=o,className:`flex items-center justify-between p-3 rounded-md cursor-pointer transition-colors ${n===r?"bg-primary/10 border border-primary/20":"hover:bg-accent"}`,onClick:()=>W(s),onMouseEnter:()=>g(r),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-md",children:e.jsx(Z,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.email})]})]})},`${s.id}-${r}`)),P&&e.jsxs("div",{className:"flex items-center justify-center p-4 bg-gray-50 dark:bg-gray-950",children:[e.jsx(Y,{className:"h-4 w-4 animate-spin mr-2"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading more users..."})]}),!_&&l.length>0&&e.jsxs("div",{className:"text-center p-4 text-xs text-muted-foreground bg-gray-50 dark:bg-gray-950 border-t",children:["âœ… All users loaded (",l.length," total)"]}),l.length===0&&!N&&e.jsx("div",{className:"text-center p-4 text-sm text-muted-foreground",children:"No users found"})]})})})}),b&&e.jsx("div",{className:"text-sm text-destructive mt-2 p-2 bg-destructive/10 rounded-md",children:b})]}),c.id&&!N&&!b&&e.jsx(q,{className:"mt-3",children:e.jsx(J,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-md",children:e.jsx(Z,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:c.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:c.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-1",children:[(O=c.roles)==null?void 0:O.slice(0,3).map((s,r)=>e.jsx($,{variant:"secondary",className:"text-xs",children:s.name},r)),c.roles&&c.roles.length>3&&e.jsxs($,{variant:"secondary",className:"text-xs",children:["+",c.roles.length-3]})]}),e.jsxs(I,{variant:"outline",size:"sm",onClick:()=>{x({id:"",email:"",name:""}),j([]),t(!1),p(""),m({id:""})},className:"ml-2",children:[e.jsx(B,{className:"h-4 w-4 mr-1"}),"Ubah"]})]})]})})})]})}function de({value:m=[],onChange:v,placeholder:h="Masukkan IP Address",error:i,disabled:f=!1}){const[c,x]=a.useState(""),N=t=>/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(t.trim()),w=t=>/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\/(?:[0-9]|[1-2][0-9]|3[0-2])$/.test(t.trim()),b=t=>{const n=t.trim();return N(n)||w(n)||n==="*"},p=()=>{const t=c.trim();if(!t||!b(t))return;if(m.includes(t)){x("");return}const n=[...m,t];v(n),x("")},l=t=>{const n=m.filter(g=>g!==t);v(n)},j=t=>{t.key==="Enter"&&(t.preventDefault(),p())},y=t=>{x(t.target.value)};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx(ee,{type:"text",value:c,onChange:y,onKeyPress:j,placeholder:h,disabled:f,className:i?"border-destructive":""})}),e.jsx(I,{type:"button",onClick:p,disabled:f||!c.trim()||!b(c),size:"sm",variant:"outline",children:e.jsx(oe,{className:"h-4 w-4"})})]}),m.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["IP Addresses (",m.length,"):"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:m.map((t,n)=>e.jsxs($,{variant:"secondary",className:"flex items-center gap-1 pr-1",children:[e.jsx("span",{className:"font-mono text-xs",children:t}),!f&&e.jsx(I,{type:"button",variant:"ghost",size:"sm",className:"h-4 w-4 p-0 hover:bg-destructive hover:text-destructive-foreground",onClick:()=>l(t),children:e.jsx(B,{className:"h-3 w-3"})})]},n))})]}),i&&e.jsx("div",{className:"text-sm text-destructive",children:i}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Format yang didukung: 192.168.1.1, 192.168.1.0/24, atau * (untuk semua IP)"})]})}function Ce({whitelistIp:m,mode:v}){const h=v==="edit",{data:i,setData:f,clearErrors:c,reset:x,errors:N,setError:w}=ie(h&&m?{...m}:{}),[b,p]=a.useState(!1);a.useEffect(()=>{i.user_id?(async()=>{try{const n=await k.get("/admin/whitelist-ip/find-by-user-id",{params:{user_id:i.user_id}});n.data&&n.data.data.ip_addresses&&f(g=>({...g,ip_addresses:n.data.data.ip_addresses}))}catch(n){console.error("Error fetching existing IPs:",n),f(g=>({...g,ip_addresses:[]}))}})():f(t=>({...t,ip_addresses:[]}))},[i.user_id]);async function l(){c(),p(!0);try{if(h)await k.put(`/admin/whitelist-ip/${i.id}`,i),M({title:"Sukses",description:"Data whitelist ip berhasil diubah"}),X.visit("/admin/whitelist-ip");else{const t=await k.post("/admin/whitelist-ip",i);M({title:"Sukses",description:"Data whitelist ip berhasil ditambah"}),X.visit("/admin/whitelist-ip/create")}}catch(t){if(t.response.status===422){const n=t.response.data.errors;w(n)}else M({variant:"destructive",title:"Gagal",description:t.response.data.message})}finally{p(!1)}}const j=h?"Ubah":"Simpan",y=h?"Mengubah...":"Menyimpan...";return e.jsx("div",{className:"p-5",children:e.jsxs("div",{className:"grid grid-cols-2 gap-x-4  gap-y-4",children:[e.jsx(R,{label:"User",error:N.user_id,required:!0,children:e.jsx(le,{value:i.user,onChange:t=>{f({...i,user_id:Number(t.id),user:t})}})}),e.jsx(R,{label:"IP Addresses",error:N.ip_addresses,required:!0,children:e.jsx(de,{value:i.ip_addresses||[],onChange:t=>f({...i,ip_addresses:t}),placeholder:"Masukkan IP Address (contoh: 192.168.1.1)"})}),e.jsx("div",{className:"col-span-2",children:e.jsx(I,{disabled:b,onClick:l,children:b?y:j})})]})})}export{Ce as default};
