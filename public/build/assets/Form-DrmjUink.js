import{r as o,a as D,j as e,q as he,W as xe,y as ae}from"./app-CQ-G37p-.js";import{h as pe}from"./moment-C5S46NFB.js";import{u as fe}from"./use-toast-XJEkqv7A.js";import{l as ge}from"./lodash-Caeo88pO.js";import{B as I}from"./button-ymMXdPy5.js";import{T as je,a as be,b as re,c as d,d as ve,e as g,f as Ne}from"./table-BSdxGOLt.js";import{I as ne}from"./input-BXXA-PDa.js";import{F as f}from"./form-group-CHZXn8bM.js";import{T as _e}from"./textarea-BvykTLwI.js";import{C as le,d as ie}from"./card-Bq41eL_q.js";import{B as Z}from"./badge-CsIJHFj0.js";import{L as ce}from"./loader-circle-i2ANfqrZ.js";import{S as ye}from"./search-B9EA-nRY.js";import{X as de}from"./x-D2Pel9EU.js";import{R as me}from"./receipt-Du83-98g.js";import{S as we}from"./SearchWarehouse-Bw-VGbhg.js";import{M as F}from"./money-input-Bb590VQ4.js";import Te from"./SelectSaleItemsDialog-CrmbSa2a.js";import Ie from"./ItemDialogForm-DdRaf7K-.js";import{P as ke}from"./pencil-XLeJOTln.js";import{T as Se}from"./trash-C6VGYEst.js";import"./index-D0iIn24t.js";import"./createLucideIcon-iWXofaGH.js";import"./label-Blk7FhF1.js";import"./index-DqZ46QiR.js";import"./dialog-CBBIkam9.js";import"./index-BHS3gC_j.js";import"./index-B9C1SM0Q.js";import"./tslib.es6-eMSY344_.js";import"./index-uJ2KZHf0.js";import"./SearchItem-DGpcvLrN.js";import"./package-Cd0mGsRo.js";import"./SearchSubUnit-CTrUekdR.js";import"./select-BSIJzAmS.js";import"./index-C7S3ohsj.js";import"./index-B9VoEdXn.js";import"./index-CZ_DqijM.js";import"./chevron-down-BOk5s691.js";function ue({onChange:u,value:h,nextRef:v,saleNumberRef:x,clearable:G=!1}){var Y;const[l,w]=o.useState({id:"",number:"",no:"",sale_date:"",total_amount:"0",payment_method:""}),[k,E]=o.useState(!1),[a,c]=o.useState(""),[m,j]=o.useState([]),[S,N]=o.useState(!1),[p,C]=o.useState(-1),[H,A]=o.useState(1),[L,R]=o.useState(!0),[M,_]=o.useState(!1),[y,U]=o.useState(""),B=o.useRef(null),O=o.useRef(null),P=o.useRef([]),$=o.useRef();o.useEffect(()=>{h&&w({id:h.id||"",number:h.no||"",no:h.purchase_order_number||"",sale_date:h.sale_date||"",total_amount:h.total_amount||"0",payment_status:h.payment_status||"",payment_method:h.payment_method||"",customer:h.customer||void 0})},[]),o.useEffect(()=>{C(-1),P.current=[]},[m]);const W=o.useCallback(s=>{if(P.current[s]&&B.current){const t=P.current[s],r=B.current;if(t){const n=t.offsetTop,i=n+t.offsetHeight,b=r.scrollTop,X=b+r.clientHeight;n<b?r.scrollTop=n-8:i>X&&(r.scrollTop=i-r.clientHeight+8)}}},[]),ee=o.useCallback(s=>{var t,r;if(!S||m.length===0){s.key==="Enter"&&((t=v==null?void 0:v.current)==null||t.focus());return}switch(s.key){case"ArrowDown":s.preventDefault(),C(n=>{const i=n<m.length-1?n+1:0;return setTimeout(()=>W(i),0),i});break;case"ArrowUp":s.preventDefault(),C(n=>{const i=n>0?n-1:m.length-1;return setTimeout(()=>W(i),0),i});break;case"Enter":s.preventDefault(),p>=0&&p<m.length?(K(m[p]),console.log("Selected sale:",m[p]),(r=v==null?void 0:v.current)==null||r.focus()):s.currentTarget===document.activeElement&&V(l.no??"");break;case"Escape":s.preventDefault(),N(!1),C(-1);break}},[S,m,p,l.no]),te=s=>{const t=s.target.value;w(r=>({...r,number:t})),$.current&&clearTimeout($.current),$.current=setTimeout(()=>{se(t)},300),c("")},se=o.useCallback(s=>{if(s.length<2){j([]),N(!1),U(""),A(1),R(!0);return}U(s),A(1),R(!0),q(s,1,!0)},[]),q=async(s,t,r=!1)=>{r?E(!0):_(!0);try{const n=await D.get("/admin/sale/list",{params:{search:s,page:t,limit:10}}),i=n.data.data||[];j(r?i:b=>[...b,...i]),R(n.data.next_page_url!==null),N(i.length>0||m.length>0)}catch(n){console.error("Error fetching sales:",n),c("Failed to fetch sales")}finally{E(!1),_(!1)}},J=o.useCallback(()=>{if(!M&&L&&y){const s=H+1;A(s),q(y,s,!1)}},[M,L,y,H]),Q=o.useCallback(s=>{const t=s.currentTarget,{scrollTop:r,scrollHeight:n,clientHeight:i}=t;n-r-i<50&&J()},[J]),V=async s=>{if(s.trim()){E(!0),c("");try{const{data:t}=await D.get(`/admin/sale/list?search=${s}`);if(t.data&&t.data.length>0){const r=t.data[0];w(r),u(r),N(!1)}else c("Sale not found")}catch(t){c("Failed to search sale"),console.error(t)}finally{E(!1)}}},K=async s=>{try{const{data:t}=await D.get(`/admin/sale/${s.id}`);w(t.data),u(t.data),N(!1),j([])}catch(t){console.error("Error selecting sale:",t)}};o.useEffect(()=>{const s=t=>{O.current&&!O.current.contains(t.target)&&N(!1)};if(S)return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[S]),o.useEffect(()=>{if(!l.id){const s=setTimeout(()=>{x!=null&&x.current&&x.current.focus()},50);return()=>clearTimeout(s)}},[l.id,x]);const z=s=>{switch(s==null?void 0:s.toLowerCase()){case"paid":return e.jsx(Z,{variant:"secondary",className:"bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200",children:"Lunas"});case"partial":return e.jsx(Z,{variant:"secondary",className:"bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200",children:"Sebagian"});case"unpaid":return e.jsx(Z,{variant:"secondary",className:"bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200",children:"Belum Bayar"});default:return e.jsx(Z,{variant:"secondary",children:s||"Unknown"})}};return e.jsxs("div",{className:"space-y-3",ref:O,children:[l.id?null:e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex gap-0 border rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-ring",children:[e.jsx(ne,{className:"border-0 rounded-none focus-visible:ring-0 focus-visible:ring-offset-0",placeholder:"Nomor Penjualan",ref:x,onChange:te,onKeyDown:ee}),e.jsx(I,{variant:"ghost",size:"sm",className:"rounded-none border-l px-3",onClick:()=>V(l.no??""),disabled:k,children:k?e.jsx(ce,{className:"h-4 w-4 animate-spin"}):e.jsx(ye,{className:"h-4 w-4"})}),G&&(l.id||l.no)&&e.jsx(I,{variant:"ghost",size:"sm",className:"rounded-none border-l px-3",onClick:()=>{var s;w({id:void 0}),j([]),N(!1),c(""),u({id:""}),(s=x==null?void 0:x.current)==null||s.focus()},children:e.jsx(de,{className:"h-4 w-4"})})]}),S&&e.jsx(le,{className:"absolute top-full left-0 right-0 z-[9999] mt-1 shadow-xl border-2",children:e.jsx(ie,{className:"p-0",children:e.jsx("div",{ref:B,className:"max-h-64 overflow-y-auto overscroll-contain",onScroll:Q,style:{scrollbarWidth:"thin",scrollbarColor:"#cbd5e1 #f1f5f9"},children:e.jsxs("div",{className:"p-2",children:[e.jsxs("div",{className:"text-xs text-muted-foreground mb-2 px-2 sticky top-0 bg-white dark:bg-black",children:["Search Results (",y,") - ",m.length," sales"]}),m.map((s,t)=>{var r;return e.jsxs("div",{ref:n=>P.current[t]=n,className:`flex items-center justify-between p-3 rounded-md cursor-pointer transition-colors ${p===t?"bg-primary/10 border border-primary/20":"hover:bg-accent"}`,onClick:()=>K(s),onMouseEnter:()=>C(t),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-md",children:e.jsx(me,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.no}),e.jsx("div",{className:"font-medium text-sm",children:s.purchase_order_number}),e.jsx("div",{className:"font-medium text-sm",children:s.sales_order_number}),e.jsx("div",{className:"text-xs text-muted-foreground",children:((r=s==null?void 0:s.customer)==null?void 0:r.name)||"No Customer"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.sale_date})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Rp ",Number.parseInt((s==null?void 0:s.total_amount)??"0").toLocaleString("id-ID")]}),e.jsx("div",{className:"mt-1",children:z((s==null?void 0:s.payment_status)??"unpaid")})]})]},`${s.id}-${t}`)}),M&&e.jsxs("div",{className:"flex items-center justify-center p-4 bg-gray-50 dark:bg-gray-950",children:[e.jsx(ce,{className:"h-4 w-4 animate-spin mr-2"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading more sales..."})]}),!L&&m.length>0&&e.jsxs("div",{className:"text-center p-4 text-xs text-muted-foreground bg-gray-50 dark:bg-gray-950 border-t",children:["âœ… All sales loaded (",m.length," total)"]}),m.length===0&&!k&&e.jsx("div",{className:"text-center p-4 text-sm text-muted-foreground",children:"No sales found"})]})})})}),a&&e.jsx("div",{className:"text-sm text-destructive mt-2 p-2 bg-destructive/10 rounded-md",children:a})]}),l.id&&!k&&!a&&e.jsx(le,{className:"mt-3",children:e.jsx(ie,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-md",children:e.jsx(me,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:l.no}),e.jsx("div",{className:"font-medium text-sm",children:l.purchase_order_number}),e.jsx("div",{className:"font-medium text-sm",children:l.sales_order_number}),e.jsx("div",{className:"text-sm text-muted-foreground",children:((Y=l.customer)==null?void 0:Y.name)||"No Customer"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:l.sale_date?new Date(l.sale_date).toLocaleDateString("id-ID"):""})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-right",children:[z((l==null?void 0:l.payment_status)??"unpaid"),e.jsxs("div",{className:"text-sm font-medium mt-1",children:["Rp ",Number.parseInt((l==null?void 0:l.total_amount)??"0").toLocaleString("id-ID")]}),l.payment_method&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:l.payment_method})]}),e.jsxs(I,{variant:"outline",size:"sm",onClick:()=>{w({id:"",number:"",no:"",sale_date:"",total_amount:"0",payment_method:""}),j([]),N(!1),c(""),u({id:""})},className:"ml-2",children:[e.jsx(de,{className:"h-4 w-4 mr-1"}),"Ubah"]})]})]})})})]})}function xt({mode:u,initialData:h,redirectUrl:v,onSuccess:x,onError:G}){var K,z,Y,s;const l=o.useRef(null),w=o.useRef(null),k=he().props.warehouse,E=()=>u==="edit"&&h?h:{sale_id:"",date:pe().format("YYYY-MM-DD"),notes:"",items:[],warehouse_id:k.id,warehouse:k,discount:"0",tax:"0"},{data:a,setData:c}=xe(E()),[m,j]=o.useState({}),[S,N]=o.useState({}),[p,C]=o.useState({}),[H,A]=o.useState(),[L,R]=o.useState(!1),{toast:M}=fe();o.useEffect(()=>{async function t(){var r;if(a.sale_id)try{const n=await D.get(`/admin/sales-return/${a.sale_id}/type-of-tax`);A(n.data.data),c({...a,type_of_tax_id:(r=n.data.data)==null?void 0:r.id,type_of_tax:n.data.data})}catch(n){console.error("Error fetching tax type:",n)}}t()},[a.sale_id]),o.useEffect(()=>{a.sale_id&&u==="create"&&a.sale&&!a.sale.items&&D.get(`/admin/sales-return/${a.sale_id}/ready-to-return`).then(({data:t})=>{var n,i,b;const r=t.data;c({...a,sales_discount:(n=a.sale)==null?void 0:n.discount,sales_subtotal:(i=a.sale)==null?void 0:i.subtotal,sales_total:(b=a.sale)==null?void 0:b.total_amount,sale:{...a.sale,items:r}})}).catch(t=>{console.error("Error fetching items:",t)})},[a.sale_id,a.sale]);const[_,y]=o.useState({show:!1,isEdit:!1,salesReturnItemIndex:0}),[U,B]=o.useState(!1),O=(t,r)=>{j(r),y({show:!0,isEdit:!0,salesReturnItemIndex:t})},P=()=>{j({}),y({show:!0,isEdit:!1,salesReturnItemIndex:0})},$=async()=>{if(_.isEdit){const t=[...a.items||[]];t[_.salesReturnItemIndex]=m,c({...a,items:t})}else c("items",[...a.items||[],m]);y({..._,show:!1})},W=()=>{B(!0)},ee=t=>{c("items",[...a.items||[],...t])},te=t=>()=>{var r;c({...a,items:(r=a.items)==null?void 0:r.filter((n,i)=>t!==i)})},se=async()=>{var t,r,n,i,b,X;R(!0);try{const T={...a,sales_subtotal:(t=a.sale)==null?void 0:t.subtotal,sales_discount:(r=a.sale)==null?void 0:r.discount,sales_total:(n=a.sale)==null?void 0:n.total_amount,subtotal:q(),total:Q()};let oe;u==="create"?oe=await D.post("/admin/sales-return",T):oe=await D.put(`/admin/sales-return/${a.id}`,T),M({title:"Berhasil",description:u==="create"?"Retur penjualan berhasil disimpan":"Retur penjualan berhasil diubah"}),v?ae.visit(v):u==="create"?ae.visit("/admin/sales-return/create"):ae.visit("/admin/sales-return"),x&&x()}catch(T){((i=T.response)==null?void 0:i.status)===422?C(T.response.data.errors):(M({variant:"destructive",title:"Gagal",description:((X=(b=T.response)==null?void 0:b.data)==null?void 0:X.message)||"Terjadi kesalahan"}),console.error("Error:",T)),G&&G(T)}finally{R(!1)}},q=()=>{var t;return ge.sum(((t=a.items)==null?void 0:t.map(r=>(r.price??0)*(r.quantity??0)))??[])},J=()=>Number(a.tax)||0,Q=()=>q()+J()-Number(a.discount||0),V=()=>L?u==="create"?"Menyimpan...":"Mengubah...":u==="create"?"Simpan":"Ubah";return e.jsxs("div",{className:"pt-5 px-5",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-4 mb-3",children:[e.jsx(f,{label:"Faktur Asal",required:!0,error:p.sale_id,children:e.jsx(ue,{value:a.sale,onChange:t=>{c({...a,sale_id:t.id,sale:t})},saleNumberRef:l})}),e.jsx(f,{label:"Potong Pada Faktur",required:!0,error:p.deduct_on_sale_id,children:e.jsx(ue,{value:a.deduct_on_sale,onChange:t=>{c({...a,deduct_on_sale_id:t.id,deduct_on_sale:t})},saleNumberRef:w})}),e.jsx(f,{label:"Nomor",required:!0,error:p.number,children:e.jsx(ne,{type:"text",value:a.number,onChange:t=>c("number",t.target.value),disabled:!0,placeholder:"Auto generated"})}),e.jsx(f,{label:"Tanggal",required:!0,error:p.date,children:e.jsx(ne,{type:"date",value:a.date,onChange:t=>c("date",t.target.value)})}),e.jsx(f,{label:"Gudang",required:!0,error:p.date,children:e.jsx(we,{value:a.warehouse,onChange:t=>{c({...a,warehouse_id:t.id,warehouse:t})}})})]}),e.jsx("div",{className:"mb-3",children:e.jsxs(je,{children:[e.jsx(be,{children:e.jsxs(re,{children:[e.jsx(d,{className:"w-[20px]",children:"No"}),e.jsx(d,{children:"Kode"}),e.jsx(d,{children:"Nama"}),e.jsx(d,{children:"Keterangan"}),e.jsx(d,{children:"Jumlah Retur"}),e.jsx(d,{children:"@Harga"}),e.jsx(d,{children:"Harga"}),e.jsx(d,{children:"Diskon"}),e.jsx(d,{children:"Total"}),e.jsx(d,{children:"Aksi"})]})}),e.jsxs(ve,{children:[(K=a.items)==null?void 0:K.map((t,r)=>{var n,i;return e.jsxs(re,{children:[e.jsx(g,{className:"w-[20px]",children:r+1}),e.jsx(g,{children:((n=t.item)==null?void 0:n.code)??"NON STOCK"}),e.jsx(g,{children:t.item_name||((i=t.item)==null?void 0:i.name)}),e.jsx(g,{children:t.notes}),e.jsx(g,{className:"text-right",children:parseFloat(t.quantity||"0")}),e.jsxs(g,{className:"text-right",children:["Rp ",Number.parseInt(t.price||"0").toLocaleString("id-ID")]}),e.jsxs(g,{className:"text-right",children:["Rp ",Number.parseInt(t.subtotal||"0").toLocaleString("id-ID")]}),e.jsx(g,{className:"text-right",children:t.discount_percent?`${t.discount_percent}%`:`Rp ${Number.parseInt(t.discount||"0").toLocaleString("id-ID")}`}),e.jsxs(g,{className:"text-right",children:["Rp ",Number.parseInt(t.total||"0").toLocaleString("id-ID")]}),e.jsx(g,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>O(r,t),children:e.jsx(ke,{className:"h-4 w-4"})}),e.jsx(I,{variant:"ghost",size:"sm",onClick:te(r),className:"text-red-600 hover:text-red-700",children:e.jsx(Se,{className:"h-4 w-4"})})]})})]},r)}),(!a.items||a.items.length===0)&&e.jsx(re,{children:e.jsx(g,{colSpan:10,className:"text-center py-8 text-muted-foreground",children:"Belum ada item yang dipilih"})})]}),e.jsxs(Ne,{children:[e.jsx(d,{className:"w-[20px]",children:"No"}),e.jsx(d,{children:"Kode"}),e.jsx(d,{children:"Nama"}),e.jsx(d,{children:"Keterangan"}),e.jsx(d,{children:"Jumlah Retur"}),e.jsx(d,{children:"@Harga"}),e.jsx(d,{children:"Harga"}),e.jsx(d,{children:"Diskon"}),e.jsx(d,{children:"Total"}),e.jsx(d,{children:"Aksi"})]})]})}),e.jsxs("div",{className:"space-x-2 mb-3",children:[e.jsx(I,{variant:"outline",onClick:P,children:"Tambah dari Master"}),e.jsx(I,{variant:"outline",onClick:W,disabled:!a.sale_id,children:"Tambah dari Faktur"})]}),e.jsx("div",{className:"mb-3",children:e.jsx(f,{label:"Catatan",required:!1,children:e.jsx(_e,{value:a.notes,onChange:t=>c("notes",t.target.value)})})}),e.jsxs("div",{className:"grid grid-cols-2 mb-3 gap-2",children:[e.jsx(f,{label:"Total Penjualan",children:e.jsx(F,{disabled:!0,value:((z=a.deduct_on_sale)==null?void 0:z.total_amount)||0})}),e.jsx(f,{label:"Diskon",children:e.jsx(F,{value:a.discount||0,onValueChange:t=>c("discount",t)})}),e.jsx(f,{label:"Subtotal Penjualan",children:e.jsx(F,{value:((Y=a.deduct_on_sale)==null?void 0:Y.subtotal)||0,disabled:!0})}),e.jsx(f,{label:"Pajak",children:e.jsx(F,{value:a.tax||0,onValueChange:t=>c("tax",t)})}),e.jsx(f,{label:"Diskon Penjualan",children:e.jsx(F,{value:((s=a.deduct_on_sale)==null?void 0:s.discount)||0,disabled:!0})}),e.jsx(f,{label:"Total Retur",children:e.jsx(F,{disabled:!0,value:Q()})})]}),e.jsx(I,{type:"button",onClick:se,disabled:L,children:V()}),e.jsx(Ie,{open:_.show,onOpenChange:t=>y({..._,show:t}),isEdit:_.isEdit,salesReturnItem:m,setSalesReturnItem:j,errors:S,typeOfTax:H,onSave:$}),e.jsx(Te,{open:U,onOpenChange:B,sale:a.sale,typeOfTax:H,onAddItems:ee})]})}export{xt as default};
