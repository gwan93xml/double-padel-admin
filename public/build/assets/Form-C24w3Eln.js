import{r as c,q as ne,W as oe,a as f,j as e,y as v}from"./app-CQ-G37p-.js";import{h as ce}from"./moment-C5S46NFB.js";import{u as le}from"./use-toast-XJEkqv7A.js";import{l as ue}from"./lodash-Caeo88pO.js";import{B as g}from"./button-ymMXdPy5.js";import{T as de,a as he,b as N,c as r,d as pe,e as l,f as me}from"./table-BSdxGOLt.js";import{I as $}from"./input-BXXA-PDa.js";import{F as o}from"./form-group-CHZXn8bM.js";import{T as xe}from"./textarea-BvykTLwI.js";import{S as L}from"./SearchPurchase-BaFV0gu4.js";import{S as je}from"./SearchWarehouse-Bw-VGbhg.js";import{M as m}from"./money-input-Bb590VQ4.js";import ge from"./ItemDialogForm-BkdjYUaa.js";import be from"./SelectPurchaseItemsDialog-XCzWagdY.js";import{P as fe}from"./pencil-XLeJOTln.js";import{T as _e}from"./trash-C6VGYEst.js";import"./index-D0iIn24t.js";import"./createLucideIcon-iWXofaGH.js";import"./label-Blk7FhF1.js";import"./index-DqZ46QiR.js";import"./card-Bq41eL_q.js";import"./loader-circle-i2ANfqrZ.js";import"./search-B9EA-nRY.js";import"./x-D2Pel9EU.js";import"./receipt-Du83-98g.js";import"./dialog-CBBIkam9.js";import"./index-BHS3gC_j.js";import"./index-B9C1SM0Q.js";import"./tslib.es6-eMSY344_.js";import"./index-uJ2KZHf0.js";import"./SearchItem-DGpcvLrN.js";import"./badge-CsIJHFj0.js";import"./package-Cd0mGsRo.js";import"./SearchSubUnit-CTrUekdR.js";import"./select-BSIJzAmS.js";import"./index-C7S3ohsj.js";import"./index-B9VoEdXn.js";import"./index-CZ_DqijM.js";import"./chevron-down-BOk5s691.js";function cs({mode:h,initialData:T,redirectUrl:y,onSuccess:R,onError:S}){var M,O,A,B;const Y=c.useRef(null),G=c.useRef(null),D=ne().props.warehouse,z=()=>h==="edit"&&T?T:{purchase_id:"",date:ce().format("YYYY-MM-DD"),notes:"",items:[],warehouse_id:D.id,warehouse:D,discount:"0",tax:"0"},{data:a,setData:n}=oe(z()),[_,I]=c.useState({}),[J,Ie]=c.useState({}),[x,V]=c.useState({}),[w,W]=c.useState(),[C,k]=c.useState(!1),{toast:E}=le();c.useEffect(()=>{async function s(){var t;if(a.purchase_id)try{const i=await f.get(`/admin/purchase-return/${a.purchase_id}/type-of-tax`);W(i.data.data),n({...a,type_of_tax_id:(t=i.data.data)==null?void 0:t.id,type_of_tax:i.data.data})}catch(i){console.error("Error fetching tax type:",i)}}s()},[a.purchase_id]),c.useEffect(()=>{a.purchase_id&&h==="create"&&a.purchase&&!a.purchase.items&&f.get(`/admin/purchase-return/${a.purchase_id}/ready-to-return`).then(({data:s})=>{var i,u,j;const t=s.data;n({...a,purchases_discount:(i=a.purchase)==null?void 0:i.discount,purchases_subtotal:(u=a.purchase)==null?void 0:u.subtotal,purchases_total:(j=a.purchase)==null?void 0:j.total_amount,purchase:{...a.purchase,items:t}})}).catch(s=>{console.error("Error fetching items:",s)})},[a.purchase_id,a.purchase]);const[p,b]=c.useState({show:!1,isEdit:!1,purchasesReturnItemIndex:0}),[Q,P]=c.useState(!1),U=(s,t)=>{I(t),b({show:!0,isEdit:!0,purchasesReturnItemIndex:s})},X=()=>{I({}),b({show:!0,isEdit:!1,purchasesReturnItemIndex:0})},Z=async()=>{if(p.isEdit){const s=[...a.items||[]];s[p.purchasesReturnItemIndex]=_,n({...a,items:s})}else n("items",[...a.items||[],_]);b({...p,show:!1})},ee=()=>{P(!0)},se=s=>{n("items",[...a.items||[],...s])},ae=s=>()=>{var t;n({...a,items:(t=a.items)==null?void 0:t.filter((i,u)=>s!==u)})},te=async()=>{var s,t,i,u,j,H;k(!0);try{const d={...a,purchases_subtotal:(s=a.purchase)==null?void 0:s.subtotal,purchases_discount:(t=a.purchase)==null?void 0:t.discount,purchases_total:(i=a.purchase)==null?void 0:i.total_amount,subtotal:F(),total:q()};let K;h==="create"?K=await f.post("/admin/purchase-return",d):K=await f.put(`/admin/purchase-return/${a.id}`,d),E({title:"Berhasil",description:h==="create"?"Retur penjualan berhasil disimpan":"Retur penjualan berhasil diubah"}),y?v.visit(y):h==="create"?v.visit("/admin/purchase-return/create"):v.visit("/admin/purchase-return"),R&&R()}catch(d){((u=d.response)==null?void 0:u.status)===422?V(d.response.data.errors):(E({variant:"destructive",title:"Gagal",description:((H=(j=d.response)==null?void 0:j.data)==null?void 0:H.message)||"Terjadi kesalahan"}),console.error("Error:",d)),S&&S(d)}finally{k(!1)}},F=()=>{var s;return ue.sum(((s=a.items)==null?void 0:s.map(t=>(t.price??0)*(t.quantity??0)))??[])},re=()=>Number(a.tax)||0,q=()=>F()+re()-Number(a.discount||0),ie=()=>C?h==="create"?"Menyimpan...":"Mengubah...":h==="create"?"Simpan":"Ubah";return e.jsxs("div",{className:"pt-5 px-5",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-4 mb-3",children:[e.jsx(o,{label:"Faktur Asal",required:!0,error:x.purchase_id,children:e.jsx(L,{value:a.purchase,onChange:s=>{n({...a,purchase_id:s.id,purchase:s})},purchaseNumberRef:Y})}),e.jsx(o,{label:"Potong Pada Faktur",required:!0,error:x.deduct_on_purchase_id,children:e.jsx(L,{value:a.deduct_on_purchase,onChange:s=>{n({...a,deduct_on_purchase_id:s.id,deduct_on_purchase:s})},purchaseNumberRef:G})}),e.jsx(o,{label:"Nomor",required:!0,error:x.number,children:e.jsx($,{type:"text",value:a.number,onChange:s=>n("number",s.target.value),disabled:!0,placeholder:"Auto generated"})}),e.jsx(o,{label:"Tanggal",required:!0,error:x.date,children:e.jsx($,{type:"date",value:a.date,onChange:s=>n("date",s.target.value)})}),e.jsx(o,{label:"Gudang",required:!0,error:x.date,children:e.jsx(je,{value:a.warehouse,onChange:s=>{n({...a,warehouse_id:s.id,warehouse:s})}})})]}),e.jsx("div",{className:"mb-3",children:e.jsxs(de,{children:[e.jsx(he,{children:e.jsxs(N,{children:[e.jsx(r,{className:"w-[20px]",children:"No"}),e.jsx(r,{children:"Kode"}),e.jsx(r,{children:"Nama"}),e.jsx(r,{children:"Keterangan"}),e.jsx(r,{children:"Jumlah Retur"}),e.jsx(r,{children:"@Harga"}),e.jsx(r,{children:"Harga"}),e.jsx(r,{children:"Diskon"}),e.jsx(r,{children:"Total"}),e.jsx(r,{children:"Aksi"})]})}),e.jsxs(pe,{children:[(M=a.items)==null?void 0:M.map((s,t)=>{var i,u;return e.jsxs(N,{children:[e.jsx(l,{className:"w-[20px]",children:t+1}),e.jsx(l,{children:((i=s.item)==null?void 0:i.code)??"NON STOCK"}),e.jsx(l,{children:s.item_name||((u=s.item)==null?void 0:u.name)}),e.jsx(l,{children:s.notes}),e.jsx(l,{className:"text-right",children:parseFloat(s.quantity||"0")}),e.jsxs(l,{className:"text-right",children:["Rp ",Number.parseInt(s.price||"0").toLocaleString("id-ID")]}),e.jsxs(l,{className:"text-right",children:["Rp ",Number.parseInt(s.subtotal||"0").toLocaleString("id-ID")]}),e.jsx(l,{className:"text-right",children:s.discount_percent?`${s.discount_percent}%`:`Rp ${Number.parseInt(s.discount||"0").toLocaleString("id-ID")}`}),e.jsxs(l,{className:"text-right",children:["Rp ",Number.parseInt(s.total||"0").toLocaleString("id-ID")]}),e.jsx(l,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>U(t,s),children:e.jsx(fe,{className:"h-4 w-4"})}),e.jsx(g,{variant:"ghost",size:"sm",onClick:ae(t),className:"text-red-600 hover:text-red-700",children:e.jsx(_e,{className:"h-4 w-4"})})]})})]},t)}),(!a.items||a.items.length===0)&&e.jsx(N,{children:e.jsx(l,{colSpan:10,className:"text-center py-8 text-muted-foreground",children:"Belum ada item yang dipilih"})})]}),e.jsxs(me,{children:[e.jsx(r,{className:"w-[20px]",children:"No"}),e.jsx(r,{children:"Kode"}),e.jsx(r,{children:"Nama"}),e.jsx(r,{children:"Keterangan"}),e.jsx(r,{children:"Jumlah Retur"}),e.jsx(r,{children:"@Harga"}),e.jsx(r,{children:"Harga"}),e.jsx(r,{children:"Diskon"}),e.jsx(r,{children:"Total"}),e.jsx(r,{children:"Aksi"})]})]})}),e.jsxs("div",{className:"space-x-2 mb-3",children:[e.jsx(g,{variant:"outline",onClick:X,children:"Tambah dari Master"}),e.jsx(g,{variant:"outline",onClick:ee,disabled:!a.purchase_id,children:"Tambah dari Faktur"})]}),e.jsx("div",{className:"mb-3",children:e.jsx(o,{label:"Catatan",required:!1,children:e.jsx(xe,{value:a.notes,onChange:s=>n("notes",s.target.value)})})}),e.jsxs("div",{className:"grid grid-cols-2 mb-3 gap-2",children:[e.jsx(o,{label:"Total Pembelian",children:e.jsx(m,{disabled:!0,value:((O=a.deduct_on_purchase)==null?void 0:O.total_amount)||0})}),e.jsx(o,{label:"Diskon",children:e.jsx(m,{value:a.discount||0,onValueChange:s=>n("discount",s)})}),e.jsx(o,{label:"Subtotal Pembelian",children:e.jsx(m,{value:((A=a.deduct_on_purchase)==null?void 0:A.subtotal)||0,disabled:!0})}),e.jsx(o,{label:"Pajak",children:e.jsx(m,{value:a.tax||0,onValueChange:s=>n("tax",s)})}),e.jsx(o,{label:"Diskon Pembelian",children:e.jsx(m,{value:((B=a.deduct_on_purchase)==null?void 0:B.discount)||0,disabled:!0})}),e.jsx(o,{label:"Total Retur",children:e.jsx(m,{disabled:!0,value:q()})})]}),e.jsx(g,{type:"button",onClick:te,disabled:C,children:ie()}),e.jsx(ge,{open:p.show,onOpenChange:s=>b({...p,show:s}),isEdit:p.isEdit,purchaseReturnItem:_,setPurchaseReturnItem:I,errors:J,typeOfTax:w,onSave:Z}),e.jsx(be,{open:Q,onOpenChange:P,purchase:a.purchase,typeOfTax:w,onAddItems:se})]})}export{cs as default};
